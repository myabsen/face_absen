<!-- index.html - WebApp face recognition absen -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Face Recognition Absen</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <style>
      video {
        border: 2px solid #000;
        border-radius: 8px;
      }
      #login-section, #absen-section, #admin-section {
        display: none;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Face Absen System</h1>

    <div id="login-section">
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Username"><br>
      <input type="password" id="password" placeholder="Password"><br>
      <button onclick="login()">Login</button>
    </div>

    <div id="absen-section">
      <h2>Absen (User)</h2>
      <video id="video" width="320" height="240" autoplay muted></video><br>
      <button onclick="scanWajahUser()">Scan & Absen</button>
      <div id="status-user"></div>
    </div>

    <div id="admin-section">
      <h2>Tambahkan Data Wajah (Admin)</h2>
      <video id="video-admin" width="320" height="240" autoplay muted></video><br>
      <input type="text" id="nama" placeholder="Nama"><br>
      <input type="text" id="posisi" placeholder="Posisi"><br>
      <button onclick="scanWajahAdmin()">Scan & Simpan</button>
      <div id="status-admin"></div>
    </div>

    <script>
      let role = "";

      async function startVideo(videoId) {
        const video = document.getElementById(videoId);
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
      }

      async function login() {
        const user = document.getElementById("username").value;
        const pass = document.getElementById("password").value;

        const res = await fetch("https://script.google.com/macros/s/AKfycbzAZBU9JxhGe_NvKvYK03k8l624A-X-UTXs9JRoF8edecF6Z6kzCAWO4xCoA-_48t-8EA/exec", {
          method: "POST",
          body: JSON.stringify({ user, pass }),
          headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
        if (data.success) {
          role = data.role;
          document.getElementById("login-section").style.display = "none";

          if (role === "user") {
            document.getElementById("absen-section").style.display = "block";
            startVideo("video");
          } else if (role === "admin") {
            document.getElementById("admin-section").style.display = "block";
            startVideo("video-admin");
          }
        } else {
          alert("Login gagal!");
        }
      }

      async function getDescriptor(videoId) {
        const video = document.getElementById(videoId);
        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        return detections ? Array.from(detections.descriptor) : null;
      }

      async function scanWajahUser() {
        document.getElementById("status-user").innerText = "Mencocokkan wajah...";
        const descriptor = await getDescriptor("video");
        if (!descriptor) return document.getElementById("status-user").innerText = "Wajah tidak terdeteksi!";

        const res = await fetch("https://script.google.com/macros/s/AKfycbzAZBU9JxhGe_NvKvYK03k8l624A-X-UTXs9JRoF8edecF6Z6kzCAWO4xCoA-_48t-8EA/exec?action=absen", {
          method: "POST",
          body: JSON.stringify({ descriptor }),
          headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
        document.getElementById("status-user").innerText = data.message;
      }

      async function scanWajahAdmin() {
        const nama = document.getElementById("nama").value;
        const posisi = document.getElementById("posisi").value;
        document.getElementById("status-admin").innerText = "Mendeteksi dan menyimpan wajah...";

        const descriptor = await getDescriptor("video-admin");
        if (!descriptor) return document.getElementById("status-admin").innerText = "Wajah tidak terdeteksi!";

        const res = await fetch("https://script.google.com/macros/s/AKfycbzAZBU9JxhGe_NvKvYK03k8l624A-X-UTXs9JRoF8edecF6Z6kzCAWO4xCoA-_48t-8EA/exec?action=simpan", {
          method: "POST",
          body: JSON.stringify({ nama, posisi, descriptor }),
          headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
        document.getElementById("status-admin").innerText = data.message;
      }

      Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('models/tiny_face_detector'),
        faceapi.nets.faceLandmark68Net.loadFromUri('models/face_landmark_68'),
        faceapi.nets.faceRecognitionNet.loadFromUri('models/face_recognition')
      ]).then(() => {
        document.getElementById("login-section").style.display = "block";
      });
    </script>
  </body>
</html>
